<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Articoli</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin: 16px 0;
    }

    /* TABS */
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      background: white;
      border: none;
      font-size: 16px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s;
    }

    .tab.active {
      color: #2563eb;
      border-bottom: 3px solid #2563eb;
    }

    .tab-content {
      display: none;
      padding: 16px;
    }

    .tab-content.active {
      display: block;
    }

    .box {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* CRUSCOTTO */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 12px;
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(45deg);
    }

    .stat-card.green {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
    }

    .stat-card.red {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 12px rgba(250, 112, 154, 0.4);
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }

    .stat-subtext {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 4px;
      position: relative;
      z-index: 1;
    }

    /* FILTRI */
    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
    }

    .filters input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .filters button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    /* FORM AGGIUNGI */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group.full {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
    }

    .btn-submit {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: #10b981;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-submit:active {
      background: #059669;
    }

    /* DESKTOP TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #2563eb;
      color: white;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      vertical-align: top;
    }

    tr:nth-child(even) {
      background: #f9fafb;
    }

    .desktop-table tbody tr {
      cursor: pointer;
    }

    .desktop-table tbody tr:hover {
      background: #e0f2fe !important;
    }

    /* MOBILE CARDS */
    .mobile-cards {
      display: none;
    }

    .card {
      background: white;
      margin-bottom: 14px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      cursor: pointer;
    }

    .card-header {
      padding: 14px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }

    .card-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .card-body {
      padding: 14px;
      display: none;
    }

    .card.expanded .card-body {
      display: block;
    }

    .card-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .card-row:last-child {
      border-bottom: none;
    }

    .card-label {
      font-weight: 600;
      color: #374151;
      flex-shrink: 0;
      margin-right: 12px;
    }

    .card-value {
      text-align: right;
      color: #1f2937;
      word-break: break-word;
    }

    .expand-icon {
      float: right;
      transition: transform 0.2s;
    }

    .card.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .msg {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }

    .msg.success {
      background: #d1fae5;
      color: #065f46;
      display: block;
    }

    .msg.error {
      background: #fee2e2;
      color: #991b1b;
      display: block;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.presente {
      background: #d1fae5;
      color: #065f46;
    }

    .badge.assente {
      background: #fee2e2;
      color: #991b1b;
    }

    /* MOBILE (IPHONE) */
    @media (max-width: 768px) {
      .filters {
        grid-template-columns: 1fr;
      }

      .desktop-table {
        display: none;
      }

      .mobile-cards {
        display: block;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .dashboard {
        grid-template-columns: 1fr 1fr;
      }

      .stat-value {
        font-size: 24px;
      }
    }
  </style>
</head>

<body>

  <h1>GESTIONE ARTICOLI</h1>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('archivio')">Archivio</button>
    <button class="tab" onclick="switchTab('aggiungi')">Aggiungi</button>
  </div>

  <!-- TAB ARCHIVIO -->
  <div id="tab-archivio" class="tab-content active">
    
    <!-- CRUSCOTTO -->
    <div class="dashboard" id="dashboard">
      <div class="stat-card">
        <div class="stat-label">Totale Articoli</div>
        <div class="stat-value" id="statTotale">0</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Valore Totale</div>
        <div class="stat-value" id="statValore">0 €</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-label">Spesa Totale</div>
        <div class="stat-value" id="statSpesa">0 €</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-label">Guadagno/Perdita</div>
        <div class="stat-value" id="statDelta">0 €</div>
        <div class="stat-subtext" id="statDeltaPercent">0%</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">Articoli Presenti</div>
        <div class="stat-value" id="statPresenti">0</div>
      </div>
    </div>

    <!-- FILTRI -->
    <div class="box filters">
      <input id="fNome" placeholder="Nome articolo">
      <input id="fCategoria" placeholder="Categoria">
      <button onclick="carica()">Filtra</button>
    </div>

    <!-- TABELLA DESKTOP -->
    <div class="box desktop-table">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Categoria</th>
            <th>Valore attuale</th>
            <th>Prezzo pagato</th>
            <th>Delta</th>
            <th>Presente</th>
          </tr>
        </thead>
        <tbody id="tableOut">
          <tr><td colspan="6">Caricamento…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- CARDS MOBILE -->
    <div id="cardsOut" class="mobile-cards">
      <div class="card">
        <div class="card-header">Caricamento…</div>
      </div>
    </div>

  </div>

  <!-- TAB AGGIUNGI -->
  <div id="tab-aggiungi" class="tab-content">
    
    <div class="box">
      <div id="formMsg" class="msg"></div>

      <form id="formAggiungi" onsubmit="aggiungi(event)">
        
        <div class="form-grid">
          <div class="form-group">
            <label>Nome *</label>
            <input type="text" name="Nome" required>
          </div>

          <div class="form-group">
            <label>Categoria</label>
            <input type="text" name="Categoria">
          </div>

          <div class="form-group full">
            <label>Descrizione</label>
            <textarea name="Descrizione"></textarea>
          </div>

          <div class="form-group">
            <label>Valore Attuale (€) *</label>
            <input type="number" step="0.01" name="ValoreAttuale" required>
          </div>

          <div class="form-group">
            <label>Prezzo Pagato (€) *</label>
            <input type="number" step="0.01" name="PrezzoPagato" required>
          </div>

          <div class="form-group">
            <label>Delta (€)</label>
            <input type="number" step="0.01" name="Delta">
          </div>

          <div class="form-group">
            <label>Valutazione Stato (1-10)</label>
            <input type="number" min="1" max="10" name="ValutazioneStato">
          </div>

          <div class="form-group full">
            <label class="checkbox-wrapper">
              <input type="checkbox" name="Presente" checked>
              Articolo Presente
            </label>
          </div>
        </div>

        <button type="submit" class="btn-submit">Aggiungi Articolo</button>
      </form>
    </div>

  </div>

  <script>
    const SUPABASE_URL = "https://xoagoblnzvdqnktpfhlk.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Uf5-1uzQzL-OqI6dA-tl_g_RHpYxNds";

    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // SWITCH TAB
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`.tab:nth-child(${tabName === 'archivio' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      if (tabName === 'archivio') {
        carica();
      }
    }

    // AGGIORNA CRUSCOTTO
    function aggiornaCruscotto(data) {
      const totale = data.length;
      const valoreAttuale = data.reduce((sum, r) => sum + (Number(r.ValoreAttuale) || 0), 0);
      const prezzoPagato = data.reduce((sum, r) => sum + (Number(r.PrezzoPagato) || 0), 0);
      const delta = valoreAttuale - prezzoPagato;
      const deltaPercent = prezzoPagato > 0 ? ((delta / prezzoPagato) * 100) : 0;
      const presenti = data.filter(r => r.Presente).length;

      document.getElementById('statTotale').textContent = totale;
      document.getElementById('statValore').textContent = valoreAttuale.toFixed(2) + ' €';
      document.getElementById('statSpesa').textContent = prezzoPagato.toFixed(2) + ' €';
      document.getElementById('statDelta').textContent = delta.toFixed(2) + ' €';
      document.getElementById('statDeltaPercent').textContent = (delta >= 0 ? '+' : '') + deltaPercent.toFixed(1) + '%';
      document.getElementById('statPresenti').textContent = presenti + '/' + totale;
    }

    // CARICA ARTICOLI
    async function carica() {
      const nome = document.getElementById("fNome").value;
      const categoria = document.getElementById("fCategoria").value;

      let query = client.from("Articoli").select("*");

      if (nome) query = query.ilike("Nome", `%${nome}%`);
      if (categoria) query = query.ilike("Categoria", `%${categoria}%`);

      const { data, error } = await query;

      const tableOut = document.getElementById("tableOut");
      const cardsOut = document.getElementById("cardsOut");

      if (error) {
        tableOut.innerHTML = `<tr><td colspan="6">${error.message}</td></tr>`;
        cardsOut.innerHTML = `<div class="card"><div class="card-header">${error.message}</div></div>`;
        return;
      }

      if (!data || data.length === 0) {
        tableOut.innerHTML = `<tr><td colspan="6">Nessun risultato</td></tr>`;
        cardsOut.innerHTML = `<div class="card"><div class="card-header">Nessun risultato</div></div>`;
        aggiornaCruscotto([]);
        return;
      }

      // AGGIORNA CRUSCOTTO
      aggiornaCruscotto(data);

      // TABELLA DESKTOP
      tableOut.innerHTML = "";
      data.forEach(r => {
        const presenteBadge = r.Presente ? '<span class="badge presente">Presente</span>' : '<span class="badge assente">Assente</span>';
        tableOut.innerHTML += `
          <tr onclick='mostraDettaglio(${JSON.stringify(r).replace(/'/g, "&apos;")})'>
            <td>${r.Nome ?? ""}</td>
            <td>${r.Categoria ?? "—"}</td>
            <td>${Number(r.ValoreAttuale || 0).toFixed(2)} €</td>
            <td>${Number(r.PrezzoPagato || 0).toFixed(2)} €</td>
            <td>${Number(r.Delta || 0).toFixed(2)} €</td>
            <td>${presenteBadge}</td>
          </tr>`;
      });

      // CARDS MOBILE
      cardsOut.innerHTML = "";
      data.forEach(r => {
        const presenteBadge = r.Presente ? '<span class="badge presente">Presente</span>' : '<span class="badge assente">Assente</span>';
        cardsOut.innerHTML += `
          <div class="card" onclick="toggleCard(this)">
            <div class="card-header">
              <div class="card-title">${r.Nome ?? ""}
                <span class="expand-icon">▼</span>
              </div>
              <div class="card-subtitle">${r.Categoria ?? "Nessuna categoria"}</div>
            </div>
            <div class="card-body">
              <div class="card-row">
                <span class="card-label">ID</span>
                <span class="card-value">${r.id}</span>
              </div>
              <div class="card-row">
                <span class="card-label">Creato il</span>
                <span class="card-value">${new Date(r.created_at).toLocaleDateString('it-IT')}</span>
              </div>
              <div class="card-row">
                <span class="card-label">Descrizione</span>
                <span class="card-value">${r.Descrizione || "—"}</span>
              </div>
              <div class="card-row">
                <span class="card-label">Valore Attuale</span>
                <span class="card-value">${Number(r.ValoreAttuale || 0).toFixed(2)} €</span>
              </div>
              <div class="card-row">
                <span class="card-label">Prezzo Pagato</span>
                <span class="card-value">${Number(r.PrezzoPagato || 0).toFixed(2)} €</span>
              </div>
              <div class="card-row">
                <span class="card-label">Delta</span>
                <span class="card-value">${Number(r.Delta || 0).toFixed(2)} €</span>
              </div>
              <div class="card-row">
                <span class="card-label">Valutazione Stato</span>
                <span class="card-value">${r.ValutazioneStato ? r.ValutazioneStato + '/10' : '—'}</span>
              </div>
              <div class="card-row">
                <span class="card-label">Presente</span>
                <span class="card-value">${presenteBadge}</span>
              </div>
            </div>
          </div>`;
      });
    }

    // MOSTRA DETTAGLIO (DESKTOP)
    function mostraDettaglio(r) {
      const info = `
ID: ${r.id}
Creato il: ${new Date(r.created_at).toLocaleDateString('it-IT')}
Nome: ${r.Nome}
Descrizione: ${r.Descrizione || '—'}
Categoria: ${r.Categoria || '—'}
Valore Attuale: ${Number(r.ValoreAttuale || 0).toFixed(2)} €
Prezzo Pagato: ${Number(r.PrezzoPagato || 0).toFixed(2)} €
Delta: ${Number(r.Delta || 0).toFixed(2)} €
Valutazione Stato: ${r.ValutazioneStato ? r.ValutazioneStato + '/10' : '—'}
Presente: ${r.Presente ? 'Sì' : 'No'}
      `.trim();
      alert(info);
    }

    // TOGGLE CARD ESPANSIONE
    function toggleCard(card) {
      card.classList.toggle('expanded');
    }

    // AGGIUNGI ARTICOLO
    async function aggiungi(e) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      
      const articolo = {
        Nome: formData.get('Nome'),
        Descrizione: formData.get('Descrizione') || null,
        Categoria: formData.get('Categoria') || null,
        ValoreAttuale: parseFloat(formData.get('ValoreAttuale')),
        PrezzoPagato: parseFloat(formData.get('PrezzoPagato')),
        Delta: formData.get('Delta') ? parseFloat(formData.get('Delta')) : null,
        ValutazioneStato: formData.get('ValutazioneStato') ? parseInt(formData.get('ValutazioneStato')) : null,
        Presente: formData.get('Presente') === 'on'
      };

      const { error } = await client.from('Articoli').insert([articolo]);

      const msg = document.getElementById('formMsg');

      if (error) {
        msg.className = 'msg error';
        msg.textContent = 'Errore: ' + error.message;
      } else {
        msg.className = 'msg success';
        msg.textContent = 'Articolo aggiunto con successo!';
        form.reset();
        
        setTimeout(() => {
          switchTab('archivio');
        }, 1500);
      }
    }

    // CARICA AL LOAD
    carica();
  </script>

</body>
</html>
