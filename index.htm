<!-- ========================================= -->
<!-- PARTE 1 DI 4 - VERSIONE FINALE CON TUTTE LE MODIFICHE -->
<!-- ========================================= -->

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <title>Nodo - Pokémon Collection</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <style>
    /* ========== RESET E BASE ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      min-height: 100vh;
      padding-bottom: 120px;
      color: #e5e7eb;
      overflow-x: hidden;
    }

    /* ========== PARTICELLE ANIMATE ========== */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #fbbf24;
      border-radius: 50%;
      opacity: 0;
      animation: float 15s infinite;
    }

    @keyframes float {
      0%, 100% {
        opacity: 0;
        transform: translateY(0) translateX(0) scale(0);
      }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% {
        opacity: 0;
        transform: translateY(-100vh) translateX(50px) scale(1);
      }
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      backdrop-filter: blur(20px);
      padding: 20px;
      box-shadow: 0 8px 40px rgba(251, 191, 36, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 3px solid #fbbf24;
      animation: headerGlow 3s ease-in-out infinite;
    }

    @keyframes headerGlow {
      0%, 100% { box-shadow: 0 8px 40px rgba(251, 191, 36, 0.3); }
      50% { box-shadow: 0 8px 60px rgba(251, 191, 36, 0.6); }
    }

    h1 {
      text-align: center;
      font-size: 38px;
      font-weight: 900;
      margin-bottom: 0;
      text-shadow: 0 0 40px rgba(251, 191, 36, 0.8);
    }

    .title-gradient {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 25%, #fbbf24 50%, #f59e0b 75%, #fbbf24 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      background-size: 300% auto;
      animation: shimmer 4s linear infinite;
    }

    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 300% center; }
    }

    /* ========== MENU NAVIGAZIONE BOTTOM ========== */
    .bottom-nav {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
    }

    .menu-main-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 8px 30px rgba(16, 185, 129, 0.6);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      position: relative;
      z-index: 2001;
    }

    .menu-main-btn:active {
      transform: scale(0.95);
    }

    .menu-main-btn.active {
      transform: rotate(45deg);
    }

    .menu-items {
      position: absolute;
      bottom: 0;
      left: 0;
      pointer-events: none;
    }

    .menu-item {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1f1f1f 0%, #0f0f0f 100%);
      border: 3px solid #10b981;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: #10b981;
      cursor: pointer;
      opacity: 0;
      transform: scale(0);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .menu-item.active {
      opacity: 1;
      transform: scale(1);
      pointer-events: all;
    }

    .menu-item:active {
      transform: scale(0.9);
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
    }

    .menu-label {
      position: absolute;
      left: 70px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 8px 16px;
      border-radius: 12px;
      border: 2px solid #10b981;
      color: #10b981;
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
      opacity: 1;
      pointer-events: all;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
    }

    .menu-item:hover .menu-label {
      opacity: 1;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      transform: translateY(-50%) scale(1.05);
    }

    /* ========== DASHBOARD CRUSCOTTI ========== */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 20px;
      position: relative;
      z-index: 1;
    }

    .stat-card {
      background: linear-gradient(135deg, #1f1f1f 0%, #0f0f0f 100%);
      padding: 28px;
      border-radius: 24px;
      box-shadow: 0 12px 50px rgba(0, 0, 0, 0.7);
      position: relative;
      overflow: hidden;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      border: 2px solid #2a2a2a;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      transform: scale(0);
      transition: transform 0.6s;
    }

    .stat-card:active::before {
      transform: scale(1);
    }

    .stat-card:active {
      transform: translateY(-8px) scale(1.02);
    }

    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
    }

    /* Colori specifici per ogni card */
    .stat-card.yellow::before { background: radial-gradient(circle, rgba(251, 191, 36, 0.15) 0%, transparent 70%); }
    .stat-card.yellow::after { background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%); }
    .stat-card.yellow .stat-icon { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); box-shadow: 0 10px 30px rgba(251, 191, 36, 0.5); }
    .stat-card.yellow .stat-value { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .stat-card.green::before { background: radial-gradient(circle, rgba(16, 185, 129, 0.15) 0%, transparent 70%); }
    .stat-card.green::after { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
    .stat-card.green .stat-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5); }
    .stat-card.green .stat-value { background: linear-gradient(135deg, #10b981 0%, #059669 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .stat-card.orange::before { background: radial-gradient(circle, rgba(249, 115, 22, 0.15) 0%, transparent 70%); }
    .stat-card.orange::after { background: linear-gradient(90deg, #f97316 0%, #ea580c 100%); }
    .stat-card.orange .stat-icon { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); box-shadow: 0 10px 30px rgba(249, 115, 22, 0.5); }
    .stat-card.orange .stat-value { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .stat-card.blue::before { background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%); }
    .stat-card.blue::after { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); }
    .stat-card.blue .stat-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.5); }
    .stat-card.blue .stat-value { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .stat-icon {
      width: 70px;
      height: 70px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin-bottom: 20px;
      color: #000;
      animation: iconPulse 2s ease-in-out infinite;
    }

    @keyframes iconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .stat-label {
      font-size: 13px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 38px;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 10px;
    }

    .stat-subtext {
      font-size: 13px;
      color: #6b7280;
      font-weight: 600;
    }

    /* ========== CONTENITORE PRINCIPALE ========== */
    .main-content {
      padding: 0 20px 40px 20px;
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    /* ========== BOX FILTRI ========== */
    .filter-box {
      background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
      border-radius: 24px;
      padding: 0;
      border: 2px solid #2a2a2a;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
      border-radius: 24px 24px 0 0;
      border-bottom: 2px solid transparent;
      transition: border-bottom-color 0.3s ease;
      position: relative;
      z-index: 10;
    }

    .filter-title {
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-toggle {
      padding: 12px 20px;
      border-radius: 16px;
      border: 2px solid #fbbf24;
      background: transparent;
      color: #fbbf24;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-toggle:active {
      transform: scale(0.95) rotate(180deg);
    }

    .filter-toggle.expanded {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
      transform: rotate(180deg);
    }

    .filter-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0 20px;
      background: transparent;
    }

    .filter-content.active {
      max-height: 2000px;
      padding: 20px;
      padding-bottom: 30px;
    }

    .filter-grid {
      display: grid;
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 700;
      color: #fbbf24;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-group input[type="text"],
    .filter-group select {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: 2px solid #2a2a2a;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #0a0a0a;
      color: #e5e7eb;
      font-weight: 500;
    }

    .filter-group input::placeholder {
      color: #6b7280;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #fbbf24;
      background: #1a1a1a;
      box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.2);
    }

    .filter-group select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fbbf24' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* ========== RANGE SLIDER ========== */
    .range-group {
      margin-bottom: 24px;
    }

    .range-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .range-label {
      font-weight: 700;
      color: #fbbf24;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .range-value {
      font-weight: 800;
      color: #10b981;
      font-size: 18px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .range-slider-container {
      position: relative;
      height: 60px;
      padding: 0 10px;
    }

    .range-track {
      position: absolute;
      top: 50%;
      left: 10px;
      right: 10px;
      height: 8px;
      background: linear-gradient(90deg, #2a2a2a 0%, #3a3a3a 100%);
      border-radius: 10px;
      transform: translateY(-50%);
    }

    .range-progress {
      position: absolute;
      height: 100%;
      background: linear-gradient(90deg, #10b981 0%, #059669 100%);
      border-radius: 10px;
      transition: all 0.1s ease;
    }

    .range-input {
      position: absolute;
      top: 50%;
      width: calc(100% - 20px);
      left: 10px;
      transform: translateY(-50%);
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      pointer-events: none;
      outline: none;
    }

    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border: 4px solid #000;
      cursor: pointer;
      pointer-events: all;
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.5);
      transition: all 0.2s ease;
    }

    .range-input::-webkit-slider-thumb:active {
      transform: scale(1.3);
      box-shadow: 0 6px 25px rgba(251, 191, 36, 0.8);
    }

    .range-input::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      border: 4px solid #000;
      cursor: pointer;
      pointer-events: all;
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.5);
      transition: all 0.2s ease;
    }

    .range-input::-moz-range-thumb:active {
      transform: scale(1.3);
      box-shadow: 0 6px 25px rgba(251, 191, 36, 0.8);
    }

    /* ========== TOGGLE BUTTONS ========== */
    .toggle-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .toggle-option input[type="checkbox"] {
      display: none;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border-radius: 16px;
      border: 2px solid #2a2a2a;
      background: #0a0a0a;
      color: #9ca3af;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toggle-option input:checked + .toggle-label {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-color: #10b981;
      color: #fff;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .toggle-label:active {
      transform: scale(0.95);
    }

    /* ========== PULSANTI FILTRO ========== */
    .filter-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-filter {
      padding: 18px;
      border-radius: 16px;
      border: none;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-apply {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
    }

    .btn-apply:active {
      transform: scale(0.95);
      box-shadow: 0 10px 30px rgba(251, 191, 36, 0.6);
    }

    .btn-reset {
      background: #2a2a2a;
      color: #e5e7eb;
    }

    .btn-reset:active {
      background: #3a3a3a;
      transform: scale(0.95);
    }
  </style>

<!-- FINE PARTE 1 - Continua con PARTE 2 -->
<!-- ========================================= -->
<!-- ========================================= -->
<!-- PARTE 2 DI 4 - VERSIONE FINALE CON TUTTE LE MODIFICHE -->
<!-- ========================================= -->

  <style>
    /* ========== PAGINAZIONE ========== */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
      border-radius: 20px;
      margin-bottom: 20px;
      border: 2px solid #2a2a2a;
    }

    .pagination-info {
      font-weight: 700;
      color: #fbbf24;
      font-size: 15px;
    }

    .pagination-info span {
      font-size: 24px;
      font-weight: 900;
      margin: 0 6px;
    }

    .pagination-controls {
      display: flex;
      gap: 12px;
    }

    .pagination-btn {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      border: 2px solid #fbbf24;
      background: #0a0a0a;
      color: #fbbf24;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      border-color: #2a2a2a;
      color: #6b7280;
    }

    .pagination-btn:not(:disabled):active {
      transform: scale(0.9);
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
    }

    /* ========== CARDS ARTICOLI ========== */
    .articles-grid {
      display: grid;
      gap: 20px;
    }

    .article-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border-radius: 24px;
      overflow: hidden;
      border: 2px solid #2a2a2a;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .article-card:active {
      transform: translateY(-6px);
      box-shadow: 0 12px 50px rgba(251, 191, 36, 0.4);
      border-color: #fbbf24;
    }

    .article-header {
      padding: 20px;
      background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
      border-bottom: 3px solid #fbbf24;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .article-image-placeholder {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      border: 3px solid #fbbf24;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 11px;
      color: #fbbf24;
      font-weight: 700;
      text-align: center;
      padding: 8px;
    }

    .article-header-info {
      flex: 1;
      min-width: 0;
    }

    .article-title {
      font-weight: 800;
      font-size: 18px;
      color: #fbbf24;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .article-title-text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .expand-icon {
      transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      font-size: 16px;
      flex-shrink: 0;
    }

    .article-card.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .article-subtitle {
      font-size: 14px;
      color: #9ca3af;
      font-weight: 600;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .article-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      background: #0f0f0f;
    }

    .article-card.expanded .article-body {
      max-height: 1000px;
    }

    .article-body-content {
      padding: 20px;
    }

    .article-row {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 1px solid #2a2a2a;
      gap: 16px;
    }

    .article-row:last-child {
      border-bottom: none;
    }

    .article-label {
      font-weight: 700;
      color: #9ca3af;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .article-value {
      text-align: right;
      color: #e5e7eb;
      font-weight: 600;
      flex-shrink: 0;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge.presente {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 2px solid #10b981;
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
    }

    .badge.assente {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 2px solid #ef4444;
      box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
    }

    .article-actions {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #2a2a2a;
    }

    .btn-edit {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
    }

    .btn-edit:active {
      transform: scale(0.95);
      box-shadow: 0 10px 30px rgba(251, 191, 36, 0.6);
    }

    /* ========== BUTTON AGGIUNGI ========== */
    .add-btn-container {
      position: fixed;
      bottom: 100px;
      right: 20px;
      z-index: 1500;
      display: none;
    }

    .add-btn-container.visible {
      display: block;
    }

    .btn-add-main {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: #fff;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 8px 30px rgba(16, 185, 129, 0.6);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .btn-add-main:active {
      transform: scale(0.95) rotate(90deg);
    }

    /* ========== MODALS ========== */
    .modal-add, .modal-edit, .modal-graph {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(8px);
      z-index: 2500;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.4s ease;
    }

    .modal-add.active, .modal-edit.active, .modal-graph.active {
      display: flex;
    }

    .modal-add.closing, .modal-edit.closing, .modal-graph.closing {
      animation: fadeOut 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .modal-add-content, .modal-edit-content {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border-radius: 28px;
      padding: 28px;
      max-width: 95vw;
      width: 100%;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 20px 80px rgba(16, 185, 129, 0.4);
      animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 3px solid #10b981;
      position: relative;
      margin: auto;
    }

    .modal-add.closing .modal-add-content,
    .modal-edit.closing .modal-edit-content,
    .modal-graph.closing .modal-graph-content {
      animation: scaleOut 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .modal-edit-content {
      box-shadow: 0 20px 80px rgba(251, 191, 36, 0.4);
      border-color: #fbbf24;
    }

    @keyframes scaleIn {
      from { transform: scale(0.8) rotate(-5deg); opacity: 0; }
      to { transform: scale(1) rotate(0); opacity: 1; }
    }

    @keyframes scaleOut {
      from { transform: scale(1) rotate(0); opacity: 1; }
      to { transform: scale(0.8) rotate(5deg); opacity: 0; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 900;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .modal-edit-content .modal-title {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: #2a2a2a;
      cursor: pointer;
      font-size: 24px;
      color: #e5e7eb;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: #ef4444;
      color: #fff;
      transform: rotate(90deg);
    }

    .modal-close:active {
      background: #dc2626;
      transform: rotate(180deg) scale(0.9);
    }

    /* ========== FORM ========== */
    .form-grid {
      display: grid;
      gap: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 700;
      color: #fbbf24;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: 2px solid #2a2a2a;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #0a0a0a;
      color: #e5e7eb;
      font-weight: 500;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: #6b7280;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #10b981;
      background: #1a1a1a;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: #0a0a0a;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid #2a2a2a;
    }

    .checkbox-wrapper:active {
      background: #1a1a1a;
      border-color: #3a3a3a;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 14px;
      cursor: pointer;
      accent-color: #10b981;
    }

    .checkbox-wrapper span {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e5e7eb;
      font-weight: 600;
    }

    .btn-submit {
      width: 100%;
      padding: 20px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-size: 18px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
      margin-top: 24px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-submit:active {
      transform: scale(0.95);
      box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
    }

    .btn-scan {
      width: 100%;
      padding: 20px;
      border-radius: 20px;
      border: 3px solid #fbbf24;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
      font-size: 18px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 8px 30px rgba(251, 191, 36, 0.5);
      margin-bottom: 24px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      position: relative;
      overflow: hidden;
    }

    .btn-scan::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn-scan:active::before {
      width: 500px;
      height: 500px;
    }

    .btn-scan:active {
      transform: scale(0.95);
      box-shadow: 0 15px 50px rgba(251, 191, 36, 0.8);
    }

    .btn-delete {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      margin-top: 24px;
    }

    .btn-delete:active {
      transform: scale(0.95);
      box-shadow: 0 10px 30px rgba(239, 68, 68, 0.6);
    }

    /* ========== CAMERA ========== */
    #cameraContainer {
      position: relative;
      display: none;
      margin: 24px 0;
      border-radius: 20px;
      overflow: hidden;
      border: 4px solid #fbbf24;
      box-shadow: 0 0 40px rgba(251, 191, 36, 0.5);
    }

    #cameraContainer.active {
      display: block;
    }

    #cameraView {
      width: 100%;
      display: block;
      background: #000;
    }

    #capturedCanvas {
      max-width: 100%;
      border-radius: 20px;
      margin: 24px 0;
      display: none;
      border: 4px solid #10b981;
      box-shadow: 0 0 40px rgba(16, 185, 129, 0.5);
    }

    /* ========== MESSAGGI ========== */
    .msg {
      padding: 18px 24px;
      border-radius: 16px;
      margin-bottom: 20px;
      display: none;
      font-weight: 700;
      animation: slideIn 0.4s ease;
      border: 3px solid;
      font-size: 15px;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .msg.success {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
      border-color: #10b981;
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    }

    .msg.error {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border-color: #ef4444;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
    }

    .msg.info {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border-color: #3b82f6;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }

    .info-box {
      background: rgba(59, 130, 246, 0.15);
      border: 2px solid #3b82f6;
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 20px;
      font-size: 14px;
      color: #60a5fa;
      font-weight: 600;
    }

    .info-box i {
      margin-right: 10px;
    }

    /* ========== MODAL GRAFICO ========== */
    .modal-graph-content {
      background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
      border-radius: 28px;
      padding: 24px;
      max-width: 100%;
      height: calc(100% - 40px);
      overflow-y: auto;
      animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: flex;
      flex-direction: column;
    }

    .chart-container {
      flex: 1;
      position: relative;
      min-height: 400px;
      background: #0a0a0a;
      border-radius: 20px;
      border: 2px solid #2a2a2a;
      padding: 20px;
    }

    .chart-container canvas {
      max-height: 100%;
    }

    /* ========== WORK IN PROGRESS ========== */
    .wip-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .wip-icon {
      font-size: 80px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: wipPulse 2s ease-in-out infinite;
      margin-bottom: 24px;
    }

    @keyframes wipPulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    .wip-text {
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 16px;
    }

    .wip-subtext {
      font-size: 16px;
      color: #9ca3af;
      font-weight: 600;
    }

    /* ========== FOOTER ========== */
    .page-footer {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      padding: 40px 20px;
      margin-top: 60px;
      border-top: 3px solid #fbbf24;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .footer-logo {
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 16px;
    }

    .footer-text {
      color: #9ca3af;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 24px;
    }

    .footer-social {
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .footer-social-link {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1f1f1f 0%, #0f0f0f 100%);
      border: 2px solid #fbbf24;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fbbf24;
      font-size: 20px;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .footer-social-link:active {
      transform: scale(0.9);
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #000;
    }

    /* ========== RESPONSIVE ========== */
    @media (min-width: 768px) {
      .dashboard {
        grid-template-columns: repeat(2, 1fr);
      }

      .filter-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .articles-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .dashboard {
        grid-template-columns: repeat(4, 1fr);
      }

      .articles-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ========== UTILITY ========== */
    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <div class="particles" id="particles"></div>

  <!-- HEADER -->
  <div class="header">
    <h1>
      <span class="title-gradient">NODO</span>
    </h1>
  </div>

  <!-- MENU NAVIGAZIONE BOTTOM -->
  <div class="bottom-nav">
    <button class="menu-main-btn" id="menuBtn" onclick="toggleMenu()">
      <i class="fas fa-bars"></i>
    </button>
    <div class="menu-items" id="menuItems"></div>
  </div>

  <!-- BUTTON AGGIUNGI -->
  <div class="add-btn-container" id="addBtnContainer">
    <button class="btn-add-main" onclick="openAddModal()">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- CONTENUTO PRINCIPALE -->
  <div class="main-content" id="mainContent"></div>

  <!-- FOOTER -->
  <div class="page-footer">
    <div class="footer-logo">NODO</div>
    <div class="footer-text">La tua collezione Pokémon sempre con te</div>
    <div class="footer-social">
      <a href="#" class="footer-social-link"><i class="fab fa-instagram"></i></a>
      <a href="#" class="footer-social-link"><i class="fab fa-twitter"></i></a>
      <a href="#" class="footer-social-link"><i class="fab fa-discord"></i></a>
    </div>
  </div>

  <!-- MODAL AGGIUNGI -->
  <div class="modal-add" id="modalAdd">
    <div class="modal-add-content">
      <div class="modal-header">
        <h2 class="modal-title"><i class="fas fa-plus-circle"></i> Aggiungi Articolo</h2>
        <button class="modal-close" onclick="closeAddModal()">✕</button>
      </div>

      <div id="addMsg" class="msg"></div>

      <button type="button" class="btn-scan" onclick="avviaScansione()">
        <i class="fas fa-camera-retro"></i> ⚡ SCANSIONA CARTA ⚡
      </button>

      <div id="cameraContainer">
        <video id="cameraView" autoplay playsinline></video>
      </div>
      
      <canvas id="capturedCanvas"></canvas>
      
      <div id="scanMsg" class="msg"></div>

      <div class="info-box">
        <i class="fas fa-lightbulb"></i>
        Il campo <strong>Guadagno/Perdita</strong> viene calcolato automaticamente
      </div>

      <form id="formAdd" onsubmit="aggiungiArticolo(event)">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fas fa-bolt"></i> Nome Carta *</label>
            <input type="text" name="Nome" id="nomeInput" required placeholder="Es. Charizard ex">
          </div>

          <div class="form-group">
            <label><i class="fas fa-layer-group"></i> Categoria</label>
            <input type="text" name="Categoria" id="categoriaInput" placeholder="Es. Carta Singola">
          </div>

          <div class="form-group">
            <label><i class="fas fa-scroll"></i> Descrizione / Espansione</label>
            <textarea name="Descrizione" id="descrizioneInput" placeholder="Es. SVI - 075/198"></textarea>
          </div>

          <div class="form-group">
            <label><i class="fas fa-chart-bar"></i> Valore Attuale (€) *</label>
            <input type="number" step="0.01" name="ValoreAttuale" id="valoreAttualeAdd" required placeholder="0.00" oninput="calcolaDeltaAdd()">
          </div>

          <div class="form-group">
            <label><i class="fas fa-receipt"></i> Prezzo Pagato (€) *</label>
            <input type="number" step="0.01" name="PrezzoPagato" id="prezzoPagatoAdd" required placeholder="0.00" oninput="calcolaDeltaAdd()">
          </div>

          <div class="form-group">
            <label><i class="fas fa-calculator"></i> Guadagno/Perdita (€)</label>
            <input type="number" step="0.01" name="Delta" id="deltaAdd" placeholder="0.00" readonly disabled>
          </div>

          <div class="form-group">
            <label><i class="fas fa-star-half-alt"></i> Valutazione Stato (1-10)</label>
            <input type="number" min="1" max="10" name="ValutazioneStato" id="statoAdd" placeholder="10">
          </div>

          <div class="form-group">
            <div class="checkbox-wrapper">
              <input type="checkbox" name="Presente" id="presenteAdd" checked>
              <span><i class="fas fa-box-open"></i> Articolo Presente</span>
            </div>
          </div>
        </div>

        <button type="submit" class="btn-submit">
          <i class="fas fa-plus-circle"></i> AGGIUNGI ALLA COLLEZIONE
        </button>
      </form>
    </div>
  </div>

  <!-- MODAL MODIFICA -->
  <div class="modal-edit" id="modalEdit">
    <div class="modal-edit-content">
      <div class="modal-header">
        <h2 class="modal-title"><i class="fas fa-edit"></i> Modifica Articolo</h2>
        <button class="modal-close" onclick="closeEditModal()">✕</button>
      </div>

      <div id="editMsg" class="msg"></div>

      <div class="info-box">
        <i class="fas fa-lightbulb"></i>
        Il campo <strong>Guadagno/Perdita</strong> viene calcolato automaticamente
      </div>

      <form id="formEdit" onsubmit="salvaModifica(event)">
        <input type="hidden" id="editId">
        
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fas fa-bolt"></i> Nome *</label>
            <input type="text" id="editNome" name="Nome" required>
          </div>

          <div class="form-group">
            <label><i class="fas fa-layer-group"></i> Categoria</label>
            <input type="text" id="editCategoria" name="Categoria">
          </div>

          <div class="form-group">
            <label><i class="fas fa-scroll"></i> Descrizione</label>
            <textarea id="editDescrizione" name="Descrizione"></textarea>
          </div>

          <div class="form-group">
            <label><i class="fas fa-chart-bar"></i> Valore Attuale (€) *</label>
            <input type="number" step="0.01" id="editValoreAttuale" name="ValoreAttuale" required oninput="calcolaDeltaEdit()">
          </div>

          <div class="form-group">
            <label><i class="fas fa-receipt"></i> Prezzo Pagato (€) *</label>
            <input type="number" step="0.01" id="editPrezzoPagato" name="PrezzoPagato" required oninput="calcolaDeltaEdit()">
          </div>

          <div class="form-group">
            <label><i class="fas fa-calculator"></i> Guadagno/Perdita (€)</label>
            <input type="number" step="0.01" id="editDelta" name="Delta" readonly disabled>
          </div>

          <div class="form-group">
            <label><i class="fas fa-star-half-alt"></i> Valutazione Stato (1-10)</label>
            <input type="number" min="1" max="10" id="editStato" name="ValutazioneStato">
          </div>

          <div class="form-group">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="editPresente" name="Presente">
              <span><i class="fas fa-box-open"></i> Articolo Presente</span>
            </div>
          </div>
        </div>

        <button type="submit" class="btn-submit">
          <i class="fas fa-save"></i> SALVA MODIFICHE
        </button>

        <button type="button" class="btn-delete" onclick="eliminaArticolo()">
          <i class="fas fa-trash-alt"></i> ELIMINA ARTICOLO
        </button>
      </form>
    </div>
  </div>

  <!-- MODAL GRAFICO -->
  <div class="modal-graph" id="modalGraph">
    <div class="modal-graph-content">
      <div class="modal-header">
        <h2 class="modal-title" id="graphTitle"><i class="fas fa-chart-area"></i> Statistiche</h2>
        <button class="modal-close" onclick="closeGraphModal()">✕</button>
      </div>
      
      <div class="chart-container">
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>
  </div>

<!-- FINE PARTE 2 - Continua con PARTE 3 -->
<!-- ========================================= -->
<!-- PARTE 3 DI 4 - VERSIONE FINALE CON TUTTE LE MODIFICHE -->
<!-- ========================================= -->

  <script>
    // ========== CONFIGURAZIONE SUPABASE ==========
    const SUPABASE_URL = "https://xoagoblnzvdqnktpfhlk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvYWdvYmxuenZkcW5rdHBmaGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1MzgzMTQsImV4cCI6MjA1MDExNDMxNH0.rZhбългария7Nz8JvQx-FqMxK6vT3kD9YhLXpI_4qP0Bs";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========== VARIABILI GLOBALI ==========
    let currentPage = 1;
    const itemsPerPage = 10;
    let allArticles = [];
    let filteredArticles = [];
    let currentChart = null;
    let currentChartColor = 'yellow';
    let stream = null;
    let menuOpen = false;
    let currentView = 'archivio';
    let currentSubmenu = null;

    // ========== DATABASE POKEMON ==========
    const POKEMON_DATABASE = {
      'SVI': { nome: 'Scarlatto e Violetto Base', max: 198 },
      'PAL': { nome: 'Paldea Evolved', max: 279 },
      'OBF': { nome: 'Obsidian Flames', max: 230 },
      'PAR': { nome: 'Paradox Rift', max: 266 },
      'PAF': { nome: 'Paldean Fates', max: 245 },
      'TEF': { nome: 'Temporal Forces', max: 218 },
      'TWM': { nome: 'Twilight Masquerade', max: 226 },
      'SHR': { nome: 'Shrouded Fable', max: 99 },
      'SCR': { nome: 'Stellar Crown', max: 175 },
      'SSP': { nome: 'Surging Sparks', max: 252 },
      nomiComuni: [
        'Pikachu', 'Charizard', 'Mewtwo', 'Mew', 'Lucario', 'Greninja', 
        'Rayquaza', 'Garchomp', 'Gardevoir', 'Umbreon', 'Espeon', 'Eevee',
        'Snorlax', 'Dragonite', 'Gyarados', 'Gengar', 'Alakazam', 'Machamp',
        'Blastoise', 'Venusaur', 'Zapdos', 'Articuno', 'Moltres', 'Lugia'
      ]
    };

    // ========== MENU NAVIGAZIONE (AGGIORNATO) ==========
    const menuStructure = {
      archivio: {
        icon: 'fas fa-archive',
        label: 'Archivio',
        action: () => loadView('archivio')
      },
      mancoliste: {
        icon: 'fas fa-list-check',
        label: 'Mancoliste',
        action: () => loadView('mancoliste')
      },
      vetrine: {
        icon: 'fas fa-shop',
        label: 'Vetrine',
        action: () => loadView('vetrine')
      },
      community: {
        icon: 'fas fa-users',
        label: 'Community',
        action: () => loadView('community')
      },
      profilo: {
        icon: 'fas fa-user',
        label: 'Profilo',
        submenu: {
          modifica_profilo: {
            icon: 'fas fa-user-edit',
            label: 'Modifica Profilo',
            action: () => loadView('modifica-profilo')
          },
          tuo_negozio: {
            icon: 'fas fa-store',
            label: 'Il tuo negozio',
            submenu: {
              vetrina: { icon: 'fas fa-shop-lock', label: 'Vetrina', action: () => loadView('vetrina-negozio') },
              mancolista: { icon: 'fas fa-list-ul', label: 'Mancolista', action: () => loadView('mancolista-negozio') },
              analisi: { icon: 'fas fa-chart-line', label: 'Analisi di mercato', action: () => loadView('analisi-mercato') },
              promozioni: { icon: 'fas fa-tag', label: 'Promozioni', action: () => loadView('promozioni') },
              indietro: { icon: 'fas fa-arrow-left', label: 'Indietro', action: () => loadSubmenu('profilo') },
              home: { icon: 'fas fa-home', label: 'Torna alla home', action: () => loadView('archivio') }
            }
          },
          indietro: { icon: 'fas fa-arrow-left', label: 'Indietro', action: () => { loadMenu(); currentSubmenu = null; } },
          home: { icon: 'fas fa-home', label: 'Torna alla home', action: () => loadView('archivio') }
        }
      }
    };

    function toggleMenu() {
      menuOpen = !menuOpen;
      const menuBtn = document.getElementById('menuBtn');
      const menuItems = document.getElementById('menuItems');
      
      menuBtn.classList.toggle('active');
      
      if (menuOpen) {
        loadMenu();
      } else {
        menuItems.innerHTML = '';
      }
    }

    function loadMenu() {
      const menuItems = document.getElementById('menuItems');
      menuItems.innerHTML = '';
      
      const items = Object.entries(menuStructure);
      
      items.forEach(([key, item], index) => {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        
        const yOffset = 80 * (index + 1);
        
        setTimeout(() => {
          menuItem.classList.add('active');
          menuItem.style.transform = `translateY(-${yOffset}px)`;
        }, index * 50);
        
        menuItem.innerHTML = `
          <i class="${item.icon}"></i>
          <div class="menu-label">${item.label}</div>
        `;
        
        menuItem.onclick = () => {
          if (item.submenu) {
            loadSubmenu(key);
          } else if (item.action) {
            item.action();
            toggleMenu();
          }
        };
        
        menuItems.appendChild(menuItem);
      });
    }

    function loadSubmenu(menuKey) {
      const menuItems = document.getElementById('menuItems');
      menuItems.innerHTML = '';
      currentSubmenu = menuKey;
      
      const submenu = menuStructure[menuKey].submenu;
      const items = Object.entries(submenu);
      
      items.forEach(([key, item], index) => {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        
        const yOffset = 80 * (index + 1);
        
        setTimeout(() => {
          menuItem.classList.add('active');
          menuItem.style.transform = `translateY(-${yOffset}px)`;
        }, index * 50);
        
        menuItem.innerHTML = `
          <i class="${item.icon}"></i>
          <div class="menu-label">${item.label}</div>
        `;
        
        menuItem.onclick = () => {
          if (item.submenu) {
            loadSubmenu(key);
          } else if (item.action) {
            item.action();
            if (key !== 'indietro') {
              toggleMenu();
            }
          }
        };
        
        menuItems.appendChild(menuItem);
      });
    }

    // ========== VIEWS ==========
    function loadView(viewName) {
      currentView = viewName;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      switch(viewName) {
        case 'archivio':
          loadArchivioView();
          break;
        case 'mancoliste':
          loadMancolisteView();
          break;
        case 'vetrine':
          loadVetrineView();
          break;
        case 'community':
          loadCommunityView();
          break;
        case 'modifica-profilo':
        case 'vetrina-negozio':
        case 'mancolista-negozio':
        case 'analisi-mercato':
        case 'promozioni':
          loadWIPView(viewName);
          break;
      }
    }

    function loadWIPView(viewName) {
      const mainContent = document.getElementById('mainContent');
      
      // NASCONDI PULSANTE AGGIUNGI
      document.getElementById('addBtnContainer').classList.remove('visible');
      
      const labels = {
        'modifica-profilo': 'Modifica Profilo',
        'vetrina-negozio': 'Vetrina',
        'mancolista-negozio': 'Mancolista',
        'analisi-mercato': 'Analisi di mercato',
        'promozioni': 'Promozioni'
      };
      
      mainContent.innerHTML = `
        <div class="wip-container">
          <div class="wip-icon">
            <i class="fas fa-hammer"></i>
          </div>
          <div class="wip-text">Work in Progress</div>
          <div class="wip-subtext">${labels[viewName]} - In arrivo presto!</div>
        </div>
      `;
    }

    // ========== MANCOLISTE VIEW (ALBUM ANIMATO) ==========
    function loadMancolisteView() {
      document.getElementById('addBtnContainer').classList.remove('visible');
      
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <style>
          .album-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            min-height: 70vh;
          }
          
          .album-book {
            position: relative;
            width: 300px;
            height: 400px;
            perspective: 1500px;
            animation: albumGrow 1.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          }
          
          @keyframes albumGrow {
            0% { transform: scale(0.3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
          }
          
          .album-cover {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(251, 191, 36, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 900;
            color: #000;
            cursor: pointer;
            transition: transform 0.3s;
            border: 4px solid #000;
          }
          
          .album-cover:hover {
            transform: scale(1.05);
          }
          
          .album-pages {
            display: none;
            width: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border-radius: 12px;
            border: 4px solid #fbbf24;
            padding: 30px 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: pageOpen 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          }
          
          @keyframes pageOpen {
            0% { opacity: 0; transform: rotateY(-90deg); }
            100% { opacity: 1; transform: rotateY(0); }
          }
          
          .album-pages.active {
            display: block;
          }
          
          .cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
          }
          
          .card-slot {
            aspect-ratio: 2/3;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 8px;
            border: 2px solid #fbbf24;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #fbbf24;
            font-weight: 700;
            text-align: center;
            padding: 5px;
            transition: transform 0.3s;
            animation: cardPop 0.5s ease;
          }
          
          @keyframes cardPop {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
          }
          
          .card-slot:nth-child(1) { animation-delay: 0.1s; }
          .card-slot:nth-child(2) { animation-delay: 0.2s; }
          .card-slot:nth-child(3) { animation-delay: 0.3s; }
          .card-slot:nth-child(4) { animation-delay: 0.4s; }
          .card-slot:nth-child(5) { animation-delay: 0.5s; }
          .card-slot:nth-child(6) { animation-delay: 0.6s; }
          
          .album-nav {
            display: flex;
            justify-content: space-between;
            gap: 12px;
          }
          
          .album-nav-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #fbbf24;
            background: #0a0a0a;
            color: #fbbf24;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          .album-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
          }
          
          .album-nav-btn:not(:disabled):active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
          }
          
          .page-indicator {
            text-align: center;
            margin: 20px 0;
            font-weight: 700;
            color: #fbbf24;
            font-size: 16px;
          }
        </style>
        
        <div class="album-container">
          <div class="album-book" id="albumBook">
            <div class="album-cover" onclick="openAlbum()">
              <div>
                <i class="fas fa-book"></i><br>
                <div style="font-size: 16px; margin-top: 10px;">ALBUM<br>MANCOLISTE</div>
              </div>
            </div>
          </div>
          
          <div class="album-pages" id="albumPages">
            <div class="page-indicator" id="pageIndicator">Pagina 1</div>
            <div class="cards-grid" id="cardsGrid"></div>
            <div class="album-nav">
              <button class="album-nav-btn" id="prevPage" onclick="prevAlbumPage()">
                <i class="fas fa-chevron-left"></i> PRECEDENTE
              </button>
              <button class="album-nav-btn" id="nextPage" onclick="nextAlbumPage()">
                SUCCESSIVA <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    let albumCurrentPage = 1;
    const albumPages = [
      ['Pikachu', 'Charizard', 'Mewtwo', 'Mew', 'Lucario', 'Greninja'],
      ['Rayquaza', 'Garchomp', 'Gardevoir', 'Umbreon', 'Espeon', 'Eevee'],
      ['Snorlax', 'Dragonite', 'Gyarados', 'Gengar', 'Alakazam', 'Machamp']
    ];

    function openAlbum() {
      document.querySelector('.album-cover').style.display = 'none';
      document.getElementById('albumPages').classList.add('active');
      renderAlbumPage();
    }

    function renderAlbumPage() {
      const grid = document.getElementById('cardsGrid');
      const cards = albumPages[albumCurrentPage - 1];
      
      grid.innerHTML = cards.map(card => `
        <div class="card-slot">
          <div>${card}</div>
        </div>
      `).join('');
      
      document.getElementById('pageIndicator').textContent = `Pagina ${albumCurrentPage} di ${albumPages.length}`;
      document.getElementById('prevPage').disabled = albumCurrentPage === 1;
      document.getElementById('nextPage').disabled = albumCurrentPage === albumPages.length;
    }

    function prevAlbumPage() {
      if (albumCurrentPage > 1) {
        albumCurrentPage--;
        renderAlbumPage();
      }
    }

    function nextAlbumPage() {
      if (albumCurrentPage < albumPages.length) {
        albumCurrentPage++;
        renderAlbumPage();
      }
    }

    // ========== VETRINE VIEW ==========
    function loadVetrineView() {
      document.getElementById('addBtnContainer').classList.remove('visible');
      
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <style>
          .vetrine-grid {
            display: grid;
            gap: 20px;
            padding: 20px;
          }
          
          .vetrina-card-big {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border-radius: 24px;
            border: 2px solid #fbbf24;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s;
          }
          
          .vetrina-card-big:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(251, 191, 36, 0.5);
          }
          
          .vetrina-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
          }
          
          .vetrina-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 3px solid #10b981;
          }
          
          .vetrina-info h3 {
            color: #fbbf24;
            font-size: 18px;
            margin-bottom: 4px;
          }
          
          .vetrina-info p {
            color: #9ca3af;
            font-size: 14px;
          }
          
          .vetrina-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
          }
          
          .vetrina-item {
            aspect-ratio: 2/3;
            background: #2a2a2a;
            border-radius: 8px;
            border: 2px solid #10b981;
          }
        </style>
        
        <div class="vetrine-grid">
          <div class="vetrina-card-big">
            <div class="vetrina-header">
              <div class="vetrina-avatar"></div>
              <div class="vetrina-info">
                <h3>Negozio Pokemon Master</h3>
                <p>Carte rare e vintage</p>
              </div>
            </div>
            <div class="vetrina-items">
              ${Array(6).fill(0).map(() => '<div class="vetrina-item"></div>').join('')}
            </div>
          </div>
          
          <div class="vetrina-card-big">
            <div class="vetrina-header">
              <div class="vetrina-avatar"></div>
              <div class="vetrina-info">
                <h3>Collezionista Pro</h3>
                <p>Espansioni moderne</p>
              </div>
            </div>
            <div class="vetrina-items">
              ${Array(6).fill(0).map(() => '<div class="vetrina-item"></div>').join('')}
            </div>
          </div>
        </div>
      `;
    }

    // ========== COMMUNITY VIEW ==========
    function loadCommunityView() {
      document.getElementById('addBtnContainer').classList.remove('visible');
      
      const mainContent = document.getElementById('mainContent');
      mainContent.innerHTML = `
        <style>
          .community-grid {
            display: grid;
            gap: 20px;
            padding: 20px;
          }
          
          .post-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            border-radius: 20px;
            border: 2px solid #2a2a2a;
            padding: 20px;
          }
          
          .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
          }
          
          .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 2px solid #fbbf24;
          }
          
          .post-user {
            flex: 1;
          }
          
          .post-user h4 {
            color: #fbbf24;
            font-size: 16px;
            margin-bottom: 4px;
          }
          
          .post-user span {
            color: #6b7280;
            font-size: 12px;
          }
          
          .post-content {
            color: #e5e7eb;
            margin-bottom: 16px;
            line-height: 1.6;
          }
          
          .post-actions {
            display: flex;
            gap: 20px;
            padding-top: 16px;
            border-top: 1px solid #2a2a2a;
          }
          
          .post-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s;
          }
          
          .post-action-btn:active {
            background: #2a2a2a;
            color: #fbbf24;
          }
          
          .event-card-big {
            background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
            border-radius: 24px;
            border: 3px solid #fbbf24;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s;
          }
          
          .event-card-big:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(251, 191, 36, 0.6);
          }
          
          .event-video {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #fbbf24;
          }
          
          .event-info {
            padding: 20px;
          }
          
          .event-info h3 {
            color: #fbbf24;
            font-size: 20px;
            margin-bottom: 8px;
          }
          
          .event-info p {
            color: #9ca3af;
            line-height: 1.6;
          }
        </style>
        
        <div class="community-grid">
          <div class="event-card-big">
            <div class="event-video">
              <i class="fas fa-calendar-days"></i>
            </div>
            <div class="event-info">
              <h3>Raduno Pokemon - Milano 2025</h3>
              <p>Unisciti a noi per il più grande evento Pokemon d'Italia! Scambi, tornei e molto altro.</p>
            </div>
          </div>
          
          <div class="post-card">
            <div class="post-header">
              <div class="post-avatar"></div>
              <div class="post-user">
                <h4>MarioCollector</h4>
                <span>2 ore fa</span>
              </div>
            </div>
            <div class="post-content">
              Ho appena completato la mia collezione di Scarlatto e Violetto! Che emozione! 🎉
            </div>
            <div class="post-actions">
              <button class="post-action-btn">
                <i class="fas fa-heart"></i>
                <span>42</span>
              </button>
              <button class="post-action-btn">
                <i class="fas fa-comment"></i>
                <span>8</span>
              </button>
            </div>
          </div>
          
          <div class="post-card">
            <div class="post-header">
              <div class="post-avatar"></div>
              <div class="post-user">
                <h4>LucaTrainer</h4>
                <span>5 ore fa</span>
              </div>
            </div>
            <div class="post-content">
              Qualcuno scambia Charizard ex? Ho doppioni di Mewtwo!
            </div>
            <div class="post-actions">
              <button class="post-action-btn">
                <i class="fas fa-heart"></i>
                <span>15</span>
              </button>
              <button class="post-action-btn">
                <i class="fas fa-comment"></i>
                <span>12</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ========== ARCHIVIO VIEW ==========
    function loadArchivioView() {
      const mainContent = document.getElementById('mainContent');
      
      // MOSTRA PULSANTE AGGIUNGI
      document.getElementById('addBtnContainer').classList.add('visible');
      
      mainContent.innerHTML = `
        <div class="dashboard" id="dashboard"></div>

        <div class="filter-box">
          <div class="filter-header" id="filterHeader">
            <div class="filter-title">
              <i class="fas fa-sliders-h"></i>
              FILTRI
            </div>
            <button class="filter-toggle" onclick="toggleFilters()" id="filterToggle">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="filter-content" id="filterContent">
            <div class="filter-grid">
              <div class="filter-group">
                <label><i class="fas fa-search"></i> Cerca Nome</label>
                <input type="text" id="fNome" placeholder="Es. Charizard, Pikachu...">
              </div>

              <div class="filter-group">
                <label><i class="fas fa-tag"></i> Categoria</label>
                <select id="fCategoria">
                  <option value="">Tutte le categorie</option>
                  <option value="Carta Singola">Carta Singola</option>
                  <option value="ETB">ETB</option>
                  <option value="Booster">Booster Pack</option>
                  <option value="Collection Box">Collection Box</option>
                  <option value="Altro">Altro</option>
                </select>
              </div>
            </div>

            <div class="range-group">
              <div class="range-header">
                <div class="range-label">
                  <i class="fas fa-euro-sign"></i>
                  Valore Attuale
                </div>
                <div class="range-value" id="rangeValoreDisplay">0€ - 1000€</div>
              </div>
              <div class="range-slider-container">
                <div class="range-track">
                  <div class="range-progress" id="rangeProgress"></div>
                </div>
                <input type="range" class="range-input" id="fValoreMin" min="0" max="1000" value="0" oninput="updateRangeSlider()">
                <input type="range" class="range-input" id="fValoreMax" min="0" max="1000" value="1000" oninput="updateRangeSlider()">
              </div>
            </div>

            <div class="range-group">
              <div class="range-header">
                <div class="range-label">
                  <i class="fas fa-star"></i>
                  Valutazione Minima
                </div>
                <div class="range-value" id="rangeStatoDisplay">Tutte</div>
              </div>
              <div class="filter-group">
                <select id="fStato" onchange="updateStatoDisplay()">
                  <option value="">Tutte le valutazioni</option>
                  <option value="10">10⭐ (Mint)</option>
                  <option value="9">9⭐+ (Near Mint+)</option>
                  <option value="8">8⭐+ (Near Mint)</option>
                  <option value="7">7⭐+ (Eccellente)</option>
                  <option value="6">6⭐+ (Buona)</option>
                  <option value="5">5⭐+ (Cattiva)</option>
                </select>
              </div>
            </div>

            <div class="toggle-group">
              <div class="toggle-option">
                <input type="checkbox" id="fPresenti" checked>
                <label for="fPresenti" class="toggle-label">
                  <i class="fas fa-check-circle"></i>
                  PRESENTI
                </label>
              </div>

              <div class="toggle-option">
                <input type="checkbox" id="fAssenti" checked>
                <label for="fAssenti" class="toggle-label">
                  <i class="fas fa-times-circle"></i>
                  ASSENTI
                </label>
              </div>

              <div class="toggle-option">
                <input type="checkbox" id="fProfit" checked>
                <label for="fProfit" class="toggle-label">
                  <i class="fas fa-arrow-up"></i>
                  PROFITTO
                </label>
              </div>

              <div class="toggle-option">
                <input type="checkbox" id="fLoss" checked>
                <label for="fLoss" class="toggle-label">
                  <i class="fas fa-arrow-down"></i>
                  PERDITA
                </label>
              </div>
            </div>

            <div class="filter-actions">
              <button class="btn-filter btn-apply" onclick="applicaFiltri()">
                <i class="fas fa-filter"></i>
                APPLICA
              </button>
              <button class="btn-filter btn-reset" onclick="resetFiltri()">
                <i class="fas fa-redo"></i>
                RESET
              </button>
            </div>
          </div>
        </div>

        <div class="pagination-container">
          <div class="pagination-info">
            Articolo <span id="pageStart">1</span>-<span id="pageEnd">10</span> di <span id="totalItems">0</span>
          </div>
          <div class="pagination-controls">
            <button class="pagination-btn" id="prevBtn" onclick="previousPage()">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="pagination-btn" id="nextBtn" onclick="nextPage()">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

        <div class="articles-grid" id="articlesGrid"></div>
      `;

      updateRangeSlider();
      caricaArticoli();
    }

    // ========== FILTRI ==========
    function toggleFilters() {
      const content = document.getElementById('filterContent');
      const toggle = document.getElementById('filterToggle');
      const isExpanded = content.classList.contains('active');
      
      if (isExpanded) {
        content.classList.remove('active');
        toggle.classList.remove('expanded');
        toggle.querySelector('i').className = 'fas fa-chevron-down';
      } else {
        content.classList.add('active');
        toggle.classList.add('expanded');
        toggle.querySelector('i').className = 'fas fa-chevron-up';
      }
    }

    function updateRangeSlider() {
      const minInput = document.getElementById('fValoreMin');
      const maxInput = document.getElementById('fValoreMax');
      const display = document.getElementById('rangeValoreDisplay');
      const progress = document.getElementById('rangeProgress');
      
      if (!minInput || !maxInput) return;
      
      let min = parseInt(minInput.value);
      let max = parseInt(maxInput.value);
      
      if (min > max - 10) {
        min = max - 10;
        minInput.value = min;
      }
      if (max < min + 10) {
        max = min + 10;
        maxInput.value = max;
      }
      
      display.textContent = `${min}€ - ${max}€`;
      
      const minPercent = (min / 1000) * 100;
      const maxPercent = (max / 1000) * 100;
      
      progress.style.left = minPercent + '%';
      progress.style.width = (maxPercent - minPercent) + '%';
    }

    function updateStatoDisplay() {
      const stato = document.getElementById('fStato').value;
      const display = document.getElementById('rangeStatoDisplay');
      if (stato) {
        display.textContent = stato + '⭐+';
      } else {
        display.textContent = 'Tutte';
      }
    }

    function applicaFiltri() {
      currentPage = 1;
      filteredArticles = filterArticles();
      renderArticles();
      updatePagination();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetFiltri() {
      document.getElementById('fNome').value = '';
      document.getElementById('fCategoria').value = '';
      document.getElementById('fValoreMin').value = '0';
      document.getElementById('fValoreMax').value = '1000';
      document.getElementById('fStato').value = '';
      document.getElementById('fPresenti').checked = true;
      document.getElementById('fAssenti').checked = true;
      document.getElementById('fProfit').checked = true;
      document.getElementById('fLoss').checked = true;
      
      updateRangeSlider();
      updateStatoDisplay();
      applicaFiltri();
    }

    function filterArticles() {
      const nome = document.getElementById('fNome').value.toLowerCase();
      const categoria = document.getElementById('fCategoria').value;
      const valoreMin = parseFloat(document.getElementById('fValoreMin').value) || 0;
      const valoreMax = parseFloat(document.getElementById('fValoreMax').value) || 999999;
      const statoMin = parseInt(document.getElementById('fStato').value) || 0;
      const presenti = document.getElementById('fPresenti').checked;
      const assenti = document.getElementById('fAssenti').checked;
      const profit = document.getElementById('fProfit').checked;
      const loss = document.getElementById('fLoss').checked;
      
      return allArticles.filter(article => {
        if (nome && !article.Nome.toLowerCase().includes(nome)) return false;
        if (categoria && article.Categoria !== categoria) return false;
        
        const valore = Number(article.ValoreAttuale) || 0;
        if (valore < valoreMin || valore > valoreMax) return false;
        
        const stato = Number(article.ValutazioneStato) || 0;
        if (statoMin > 0 && stato < statoMin) return false;
        
        if (!presenti && article.Presente) return false;
        if (!assenti && !article.Presente) return false;
        
        const delta = valore - (Number(article.PrezzoPagato) || 0);
        if (!profit && !loss) return true;
        if (profit && !loss && delta <= 0) return false;
        if (!profit && loss && delta >= 0) return false;
        
        return true;
      });
    }

    // ========== PAGINAZIONE ==========
    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderArticles();
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredArticles.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderArticles();
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function updatePagination() {
      const totalItems = filteredArticles.length;
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage + 1;
      const end = Math.min(currentPage * itemsPerPage, totalItems);
      
      document.getElementById('pageStart').textContent = totalItems > 0 ? start : 0;
      document.getElementById('pageEnd').textContent = end;
      document.getElementById('totalItems').textContent = totalItems;
      
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    // ========== CARICAMENTO ARTICOLI ==========
    async function caricaArticoli() {
      try {
        const { data, error } = await client
          .from("Articoli")
          .select("*")
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allArticles = data || [];
        filteredArticles = [...allArticles];
        
        console.log('📦 Articoli caricati:', allArticles.length);
        
        renderDashboard();
        renderArticles();
        updatePagination();
      } catch (error) {
        console.error('❌ Errore caricamento:', error);
      }
    }

    function renderDashboard() {
      const dashboard = document.getElementById('dashboard');
      if (!dashboard) return;
      
      const totale = allArticles.length;
      const valoreAttuale = allArticles.reduce((sum, r) => sum + (Number(r.ValoreAttuale) || 0), 0);
      const prezzoPagato = allArticles.reduce((sum, r) => sum + (Number(r.PrezzoPagato) || 0), 0);
      const delta = valoreAttuale - prezzoPagato;
      const deltaPercent = prezzoPagato > 0 ? ((delta / prezzoPagato) * 100) : 0;
      
      dashboard.innerHTML = `
        <div class="stat-card yellow" onclick="apriGrafico('totale', 'yellow')">
          <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
          <div class="stat-label">Totale Articoli</div>
          <div class="stat-value">${totale}</div>
          <div class="stat-subtext">nella collezione</div>
        </div>
        
        <div class="stat-card green" onclick="apriGrafico('valore', 'green')">
          <div class="stat-icon"><i class="fas fa-gem"></i></div>
          <div class="stat-label">Valore Totale</div>
          <div class="stat-value">${valoreAttuale.toFixed(2)} €</div>
          <div class="stat-subtext">valore di mercato</div>
        </div>
        
        <div class="stat-card orange" onclick="apriGrafico('spesa', 'orange')">
          <div class="stat-icon"><i class="fas fa-wallet"></i></div>
          <div class="stat-label">Spesa Totale</div>
          <div class="stat-value">${prezzoPagato.toFixed(2)} €</div>
          <div class="stat-subtext">investimento iniziale</div>
        </div>
        
        <div class="stat-card blue" onclick="apriGrafico('performance', 'blue')">
          <div class="stat-icon"><i class="fas fa-rocket"></i></div>
          <div class="stat-label">Performance</div>
          <div class="stat-value">${delta >= 0 ? '+' : ''}${delta.toFixed(2)} €</div>
          <div class="stat-subtext">${delta >= 0 ? '+' : ''}${deltaPercent.toFixed(1)}%</div>
        </div>
      `;
    }

    function renderArticles() {
      const grid = document.getElementById('articlesGrid');
      if (!grid) return;
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageArticles = filteredArticles.slice(start, end);
      
      if (pageArticles.length === 0) {
        grid.innerHTML = `
          <div class="wip-container">
            <div class="wip-icon"><i class="fas fa-inbox"></i></div>
            <div class="wip-text">Nessun Articolo</div>
            <div class="wip-subtext">Prova a modificare i filtri</div>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = pageArticles.map(article => createArticleCard(article)).join('');
    }

    function createArticleCard(article) {
      const delta = (Number(article.ValoreAttuale) || 0) - (Number(article.PrezzoPagato) || 0);
      const statoStelle = article.ValutazioneStato ? '⭐'.repeat(Math.min(article.ValutazioneStato, 10)) : '—';
      const presenteBadge = article.Presente 
        ? '<span class="badge presente"><i class="fas fa-check"></i> PRESENTE</span>' 
        : '<span class="badge assente"><i class="fas fa-times"></i> ASSENTE</span>';
      
      return `
        <div class="article-card" id="card-${article.id}">
          <div class="article-header" onclick="toggleArticleCard(${article.id})">
            <div class="article-image-placeholder">
              IMMAGINE DI PROVA
            </div>
            <div class="article-header-info">
              <div class="article-title">
                <span class="article-title-text">${article.Nome || 'Senza nome'}</span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="article-subtitle">
                <i class="fas fa-layer-group"></i> ${article.Categoria || 'Nessuna categoria'}
              </div>
            </div>
          </div>
          <div class="article-body">
            <div class="article-body-content">
              <div class="article-row">
                <span class="article-label"><i class="fas fa-gem"></i> VALORE</span>
                <span class="article-value" style="color: #10b981; font-weight: 700;">${Number(article.ValoreAttuale || 0).toFixed(2)} €</span>
              </div>
              <div class="article-row">
                <span class="article-label"><i class="fas fa-receipt"></i> PREZZO PAGATO</span>
                <span class="article-value">${Number(article.PrezzoPagato || 0).toFixed(2)} €</span>
              </div>
              <div class="article-row">
                <span class="article-label"><i class="fas fa-chart-line"></i> GUADAGNO/PERDITA</span>
                <span class="article-value" style="color: ${delta >= 0 ? '#10b981' : '#ef4444'}; font-weight: 800;">
                  ${delta >= 0 ? '+' : ''}${delta.toFixed(2)} €
                </span>
              </div>
              <div class="article-row">
                <span class="article-label"><i class="fas fa-star"></i> VALUTAZIONE</span>
                <span class="article-value">${statoStelle}</span>
              </div>
              <div class="article-row">
                <span class="article-label"><i class="fas fa-warehouse"></i> STATO</span>
                <span class="article-value">${presenteBadge}</span>
              </div>
              <div class="article-actions">
                <button class="btn-edit" onclick="apriModifica(${article.id})">
                  <i class="fas fa-edit"></i> MODIFICA
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function toggleArticleCard(id) {
      const card = document.getElementById(`card-${id}`);
      if (card) {
        card.classList.toggle('expanded');
      }
    }

    function apriModifica(id) {
      const article = allArticles.find(a => a.id === id);
      if (!article) return;
      
      // Reset scroll e blocca body
      window.scrollTo({ top: 0, behavior: 'instant' });
      document.body.style.overflow = 'hidden';
      
      document.getElementById('editId').value = article.id;
      document.getElementById('editNome').value = article.Nome || '';
      document.getElementById('editCategoria').value = article.Categoria || '';
      document.getElementById('editDescrizione').value = article.Descrizione || '';
      document.getElementById('editValoreAttuale').value = article.ValoreAttuale || '';
      document.getElementById('editPrezzoPagato').value = article.PrezzoPagato || '';
      document.getElementById('editStato').value = article.ValutazioneStato || '';
      document.getElementById('editPresente').checked = article.Presente || false;
      calcolaDeltaEdit();
      
      const modal = document.getElementById('modalEdit');
      modal.scrollTop = 0;
      modal.classList.add('active');
    }

    // ========== MODALS ==========
    function openAddModal() {
      const modal = document.getElementById('modalAdd');
      const modalContent = modal.querySelector('.modal-add-content');
      
      // Reset scroll del modal e della pagina
      window.scrollTo({ top: 0, behavior: 'instant' });
      modal.scrollTop = 0;
      if (modalContent) modalContent.scrollTop = 0;
      
      // Blocca scroll della pagina
      document.body.style.overflow = 'hidden';
      
      // Forza reflow per assicurare posizionamento corretto
      modal.style.display = 'none';
      modal.offsetHeight; // trigger reflow
      
      modal.classList.remove('closing');
      modal.classList.add('active');
      modal.style.display = '';
    }

    function closeAddModal() {
      const modal = document.getElementById('modalAdd');
      modal.classList.add('closing');
      
      // Riattiva scroll della pagina
      document.body.style.overflow = '';
      
      setTimeout(() => {
        modal.classList.remove('active', 'closing');
      }, 400);
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        document.getElementById('cameraContainer').classList.remove('active');
      }
    }

    function closeEditModal() {
      const modal = document.getElementById('modalEdit');
      modal.classList.add('closing');
      
      // Riattiva scroll della pagina
      document.body.style.overflow = '';
      
      setTimeout(() => {
        modal.classList.remove('active', 'closing');
      }, 400);
    }

    function closeGraphModal() {
      const modal = document.getElementById('modalGraph');
      modal.classList.add('closing');
      
      // Riattiva scroll della pagina
      document.body.style.overflow = '';
      
      setTimeout(() => {
        modal.classList.remove('active', 'closing');
        if (currentChart) {
          currentChart.destroy();
          currentChart = null;
        }
      }, 400);
    }

    // ========== FORM FUNCTIONS ==========
    function calcolaDeltaAdd() {
      const valore = parseFloat(document.getElementById('valoreAttualeAdd').value) || 0;
      const prezzo = parseFloat(document.getElementById('prezzoPagatoAdd').value) || 0;
      document.getElementById('deltaAdd').value = (valore - prezzo).toFixed(2);
    }

    function calcolaDeltaEdit() {
      const valore = parseFloat(document.getElementById('editValoreAttuale').value) || 0;
      const prezzo = parseFloat(document.getElementById('editPrezzoPagato').value) || 0;
      document.getElementById('editDelta').value = (valore - prezzo).toFixed(2);
    }

    async function aggiungiArticolo(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const valore = parseFloat(formData.get('ValoreAttuale'));
      const prezzo = parseFloat(formData.get('PrezzoPagato'));

      const articolo = {
        Nome: formData.get('Nome'),
        Descrizione: formData.get('Descrizione') || null,
        Categoria: formData.get('Categoria') || null,
        ValoreAttuale: valore,
        PrezzoPagato: prezzo,
        Delta: valore - prezzo,
        ValutazioneStato: formData.get('ValutazioneStato') ? parseInt(formData.get('ValutazioneStato')) : null,
        Presente: formData.get('Presente') === 'on'
      };

      const { error } = await client.from('Articoli').insert([articolo]);
      const msg = document.getElementById('addMsg');

      if (error) {
        msg.className = 'msg error';
        msg.textContent = '❌ ERRORE: ' + error.message;
        msg.style.display = 'block';
      } else {
        msg.className = 'msg success';
        msg.textContent = '✅ AGGIUNTO!';
        msg.style.display = 'block';
        form.reset();
        document.getElementById('deltaAdd').value = '';
        setTimeout(() => {
          closeAddModal();
          caricaArticoli();
        }, 1500);
      }
    }

    async function salvaModifica(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const valore = parseFloat(formData.get('ValoreAttuale'));
      const prezzo = parseFloat(formData.get('PrezzoPagato'));
      const id = document.getElementById('editId').value;

      const articolo = {
        Nome: formData.get('Nome'),
        Descrizione: formData.get('Descrizione') || null,
        Categoria: formData.get('Categoria') || null,
        ValoreAttuale: valore,
        PrezzoPagato: prezzo,
        Delta: valore - prezzo,
        ValutazioneStato: formData.get('ValutazioneStato') ? parseInt(formData.get('ValutazioneStato')) : null,
        Presente: formData.get('Presente') === 'on'
      };

      const { error } = await client.from('Articoli').update(articolo).eq('id', id);
      const msg = document.getElementById('editMsg');

      if (error) {
        msg.className = 'msg error';
        msg.textContent = '❌ ERRORE: ' + error.message;
        msg.style.display = 'block';
      } else {
        msg.className = 'msg success';
        msg.textContent = '✅ SALVATO!';
        msg.style.display = 'block';
        setTimeout(() => {
          closeEditModal();
          caricaArticoli();
        }, 1500);
      }
    }

    async function eliminaArticolo() {
      const id = document.getElementById('editId').value;
      const nome = document.getElementById('editNome').value;
      if (!confirm(`⚠️ ELIMINARE "${nome}"?`)) return;

      const { error } = await client.from('Articoli').delete().eq('id', id);
      const msg = document.getElementById('editMsg');

      if (error) {
        msg.className = 'msg error';
        msg.textContent = '❌ ERRORE: ' + error.message;
        msg.style.display = 'block';
      } else {
        msg.className = 'msg success';
        msg.textContent = '✅ ELIMINATO!';
        msg.style.display = 'block';
        setTimeout(() => {
          closeEditModal();
          caricaArticoli();
        }, 1500);
      }
    }

<!-- FINE PARTE 3 - Continua con PARTE 4 -->
<!-- ========================================= -->
<!-- PARTE 4 DI 4 - VERSIONE FINALE COMPLETA -->
<!-- ========================================= -->

    // ========== GRAFICI CON COLORI DINAMICI ==========
    async function apriGrafico(tipo, colorTheme) {
      const { data, error } = await client.from("Articoli").select("*").order('created_at', { ascending: true });
      
      if (error || !data || data.length === 0) {
        alert('⚠️ Nessun dato disponibile');
        return;
      }

      // Reset scroll e blocca body
      window.scrollTo({ top: 0, behavior: 'instant' });
      document.body.style.overflow = 'hidden';

      currentChartColor = colorTheme;
      
      const modal = document.getElementById('modalGraph');
      modal.scrollTop = 0;
      modal.classList.remove('closing');
      modal.classList.add('active');

      // Applica colore al bordo e titolo del modal
      const modalContent = modal.querySelector('.modal-graph-content');
      const modalTitle = document.getElementById('graphTitle');
      
      const colors = {
        yellow: { border: '#fbbf24', gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)' },
        green: { border: '#10b981', gradient: 'linear-gradient(135deg, #10b981 0%, #059669 100%)' },
        orange: { border: '#f97316', gradient: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)' },
        blue: { border: '#3b82f6', gradient: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)' }
      };
      
      modalContent.style.borderColor = colors[colorTheme].border;
      modalContent.style.boxShadow = `0 20px 80px rgba(${colorTheme === 'yellow' ? '251, 191, 36' : colorTheme === 'green' ? '16, 185, 129' : colorTheme === 'orange' ? '249, 115, 22' : '59, 130, 246'}, 0.4)`;
      modalTitle.style.background = colors[colorTheme].gradient;
      modalTitle.style.webkitBackgroundClip = 'text';
      modalTitle.style.webkitTextFillColor = 'transparent';
      modalTitle.style.backgroundClip = 'text';

      if (currentChart) {
        currentChart.destroy();
      }

      const ctx = document.getElementById('chartCanvas').getContext('2d');
      let chartConfig;

      const chartColors = {
        yellow: { main: '#fbbf24', light: 'rgba(251, 191, 36, 0.2)' },
        green: { main: '#10b981', light: 'rgba(16, 185, 129, 0.2)' },
        orange: { main: '#f97316', light: 'rgba(249, 115, 22, 0.2)' },
        blue: { main: '#3b82f6', light: 'rgba(59, 130, 246, 0.2)' }
      };

      switch(tipo) {
        case 'totale':
          chartConfig = {
            type: 'line',
            data: {
              labels: data.map(r => new Date(r.created_at).toLocaleDateString('it-IT')),
              datasets: [{
                label: '📦 Numero Articoli',
                data: data.map((r, i) => i + 1),
                borderColor: chartColors[colorTheme].main,
                backgroundColor: chartColors[colorTheme].light,
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: chartColors[colorTheme].main,
                pointBorderColor: '#000',
                pointBorderWidth: 2
              }]
            }
          };
          document.getElementById('graphTitle').innerHTML = '<i class="fas fa-layer-group"></i> CRESCITA COLLEZIONE';
          break;

        case 'valore':
          let cumVal = 0;
          chartConfig = {
            type: 'line',
            data: {
              labels: data.map(r => new Date(r.created_at).toLocaleDateString('it-IT')),
              datasets: [{
                label: '💎 Valore Totale (€)',
                data: data.map(r => cumVal += Number(r.ValoreAttuale || 0)),
                borderColor: chartColors[colorTheme].main,
                backgroundColor: chartColors[colorTheme].light,
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: chartColors[colorTheme].main,
                pointBorderColor: '#000',
                pointBorderWidth: 2
              }]
            }
          };
          document.getElementById('graphTitle').innerHTML = '<i class="fas fa-gem"></i> VALORE NEL TEMPO';
          break;

        case 'spesa':
          let cumSpe = 0;
          chartConfig = {
            type: 'line',
            data: {
              labels: data.map(r => new Date(r.created_at).toLocaleDateString('it-IT')),
              datasets: [{
                label: '💳 Spesa Totale (€)',
                data: data.map(r => cumSpe += Number(r.PrezzoPagato || 0)),
                borderColor: chartColors[colorTheme].main,
                backgroundColor: chartColors[colorTheme].light,
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: chartColors[colorTheme].main,
                pointBorderColor: '#000',
                pointBorderWidth: 2
              }]
            }
          };
          document.getElementById('graphTitle').innerHTML = '<i class="fas fa-wallet"></i> INVESTIMENTO';
          break;

        case 'performance':
          const values = data.map(r => Number(r.ValoreAttuale || 0) - Number(r.PrezzoPagato || 0));
          chartConfig = {
            type: 'bar',
            data: {
              labels: data.map(r => r.Nome),
              datasets: [{
                label: '📊 Guadagno/Perdita (€)',
                data: values,
                backgroundColor: values.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                borderColor: values.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                borderWidth: 2
              }]
            }
          };
          document.getElementById('graphTitle').innerHTML = '<i class="fas fa-rocket"></i> PERFORMANCE';
          break;
      }

      currentChart = new Chart(ctx, {
        type: chartConfig.type,
        data: chartConfig.data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1500,
            easing: 'easeInOutQuart'
          },
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              labels: {
                color: '#e5e7eb',
                font: { size: 14, weight: 'bold' },
                padding: 15
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(10, 10, 10, 0.95)',
              titleColor: chartColors[colorTheme].main,
              bodyColor: '#e5e7eb',
              borderColor: chartColors[colorTheme].main,
              borderWidth: 2,
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              cornerRadius: 10,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += context.parsed.y.toFixed(2);
                  }
                  return label;
                }
              }
            }
          },
          scales: chartConfig.type !== 'doughnut' && chartConfig.type !== 'pie' ? {
            x: {
              ticks: { 
                color: '#9ca3af',
                font: { size: 11, weight: '600' },
                maxRotation: 45,
                minRotation: 0
              },
              grid: { 
                color: '#2a2a2a',
                lineWidth: 1
              }
            },
            y: {
              ticks: { 
                color: '#9ca3af',
                font: { size: 11, weight: '600' }
              },
              grid: { 
                color: '#2a2a2a',
                lineWidth: 1
              }
            }
          } : {}
        }
      });
    }

    // ========== SCANSIONE CARTA ==========
    async function avviaScansione() {
      const video = document.getElementById('cameraView');
      const container = document.getElementById('cameraContainer');
      const scanMsg = document.getElementById('scanMsg');
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 3840 },
            height: { ideal: 2160 }
          }
        });
        
        video.srcObject = stream;
        container.classList.add('active');
        
        scanMsg.className = 'msg info';
        scanMsg.style.display = 'block';
        scanMsg.innerHTML = '<i class="fas fa-camera"></i> <strong>⚡ FOTOCAMERA ATTIVA ⚡</strong> - Tocca per scattare';
        
        video.onclick = () => scansionaCarta();
        
      } catch (err) {
        scanMsg.className = 'msg error';
        scanMsg.style.display = 'block';
        scanMsg.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>ERRORE:</strong> ' + err.message;
      }
    }

    async function scansionaCarta() {
      const video = document.getElementById('cameraView');
      const canvas = document.getElementById('capturedCanvas');
      const container = document.getElementById('cameraContainer');
      const scanMsg = document.getElementById('scanMsg');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(video, 0, 0);
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      
      container.classList.remove('active');
      canvas.style.display = 'block';
      
      scanMsg.className = 'msg info';
      scanMsg.innerHTML = '<i class="fas fa-cog fa-spin"></i> <strong>⚡ ANALISI IN CORSO ⚡</strong>';
      
      await elaborazioneCarta(canvas, ctx);
    }

    async function elaborazioneCarta(canvas, ctx) {
      const scanMsg = document.getElementById('scanMsg');
      const w = canvas.width;
      const h = canvas.height;
      
      try {
        const nomeCanvas = document.createElement('canvas');
        const nomeCtx = nomeCanvas.getContext('2d');
        nomeCanvas.width = Math.floor(w * 0.76);
        nomeCanvas.height = Math.floor(h * 0.10);
        nomeCtx.drawImage(canvas, 
          Math.floor(w * 0.12), Math.floor(h * 0.06),
          Math.floor(w * 0.76), Math.floor(h * 0.10),
          0, 0, nomeCanvas.width, nomeCanvas.height
        );
        
        preprocessZona(nomeCtx, nomeCanvas.width, nomeCanvas.height);
        
        scanMsg.innerHTML = '<i class="fas fa-bolt fa-spin"></i> <strong>SCANSIONE NOME...</strong> 30%';
        
        const nomeResult = await Tesseract.recognize(nomeCanvas.toDataURL('image/png'), 'eng+ita', {
          logger: () => {},
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzÀÈÉÌÒÙàèéìòù '
        });
        
        const expCanvas = document.createElement('canvas');
        const expCtx = expCanvas.getContext('2d');
        expCanvas.width = Math.floor(w * 0.39);
        expCanvas.height = Math.floor(h * 0.08);
        expCtx.drawImage(canvas,
          Math.floor(w * 0.03), Math.floor(h * 0.87),
          Math.floor(w * 0.39), Math.floor(h * 0.08),
          0, 0, expCanvas.width, expCanvas.height
        );
        
        preprocessZona(expCtx, expCanvas.width, expCanvas.height);
        
        scanMsg.innerHTML = '<i class="fas fa-bolt fa-spin"></i> <strong>SCANSIONE ESPANSIONE...</strong> 70%';
        
        const expResult = await Tesseract.recognize(expCanvas.toDataURL('image/png'), 'eng', {
          logger: () => {},
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789/ '
        });
        
        scanMsg.innerHTML = '<i class="fas fa-database fa-spin"></i> <strong>VALIDAZIONE...</strong> 90%';
        
        const info = estraiDatiCarta(nomeResult.data.text, expResult.data.text);
        
        if (info.nome) {
          document.getElementById('nomeInput').value = info.nome;
          document.getElementById('descrizioneInput').value = info.descrizione || '';
          
          scanMsg.className = 'msg success';
          scanMsg.innerHTML = `
            <i class="fas fa-check-circle"></i> <strong>⚡ CARTA RICONOSCIUTA! ⚡</strong><br>
            <div style="margin-top: 10px; font-size: 16px;">
              🎴 <strong>${info.nome}</strong>
              ${info.descrizione ? '<br>📦 <strong>' + info.descrizione + '</strong>' : ''}
            </div>
          `;
          
          setTimeout(() => {
            canvas.style.display = 'none';
            scanMsg.style.display = 'none';
          }, 5000);
          
        } else {
          scanMsg.className = 'msg error';
          scanMsg.innerHTML = '<i class="fas fa-times-circle"></i> <strong>CARTA NON RICONOSCIUTA</strong> - Riprova o inserisci manualmente';
        }
        
      } catch (err) {
        scanMsg.className = 'msg error';
        scanMsg.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>ERRORE:</strong> ' + err.message;
        console.error('Errore scansione:', err);
      }
    }

    function preprocessZona(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
        const adjusted = brightness > 140 ? 255 : brightness < 90 ? 0 : brightness;
        
        data[i] = data[i + 1] = data[i + 2] = adjusted;
      }
      
      ctx.putImageData(imageData, 0, 0);
    }

    function estraiDatiCarta(testoNome, testoExp) {
      let nomeRaw = testoNome
        .trim()
        .replace(/[^a-zA-ZÀ-ÿ\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
      
      nomeRaw = nomeRaw.replace(/^(HP|ATK|DEF|Basic|Stage|Evolution|Pokémon)\s*/gi, '').trim();
      
      let nomeTrovato = '';
      const nomeLC = nomeRaw.toLowerCase();
      
      for (const pokemon of POKEMON_DATABASE.nomiComuni) {
        if (nomeLC.includes(pokemon.toLowerCase()) || 
            pokemon.toLowerCase().includes(nomeLC)) {
          nomeTrovato = pokemon;
          break;
        }
      }
      
      if (!nomeTrovato) nomeTrovato = nomeRaw;
      
      let espansione = '';
      let numero = '';
      
      const pattern = /([A-Z]{2,4})\s*(\d{1,4})\s*[\/\\]\s*(\d{1,4})/;
      const match = testoExp.match(pattern);
      
      if (match) {
        const sigla = match[1].toUpperCase();
        const num1 = parseInt(match[2]);
        const num2 = parseInt(match[3]);
        
        if (POKEMON_DATABASE[sigla]) {
          espansione = sigla;
          numero = `${String(num1).padStart(3, '0')}/${String(num2).padStart(3, '0')}`;
        }
      }
      
      if (!espansione) {
        for (const sigla in POKEMON_DATABASE) {
          if (sigla === 'nomiComuni') continue;
          if (testoExp.includes(sigla)) {
            espansione = sigla;
            break;
          }
        }
      }
      
      const descrizione = espansione && numero ? 
        `${espansione} - ${numero}` : 
        espansione || '';
      
      return { 
        nome: nomeTrovato, 
        espansione, 
        numero, 
        descrizione 
      };
    }

    // ========== PARTICELLE ==========
    function creaParticelle() {
      const container = document.getElementById('particles');
      if (!container) return;
      for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 15 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        container.appendChild(particle);
      }
    }

    // ========== INIZIALIZZAZIONE ==========
    window.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 Pagina caricata!');
      creaParticelle();
      console.log('✅ Particelle create');
      
      setTimeout(() => {
        console.log('⏱️ Carico archivio...');
        loadView('archivio');
      }, 100);
    });

    // ========== CHIUSURA MODALS AL CLICK ESTERNO ==========
    document.addEventListener('click', (e) => {
      if (e.target.id === 'modalAdd') closeAddModal();
      if (e.target.id === 'modalEdit') closeEditModal();
      if (e.target.id === 'modalGraph') closeGraphModal();
    });
  </script>
</body>
</html>

<!-- ========================================= -->
<!-- FINE - VERSIONE FINALE COMPLETA! -->
<!-- ========================================= -->

<!-- 
✅ TUTTE LE MODIFICHE IMPLEMENTATE:
1. ✅ Pulsanti close con animazione (hover + active)
2. ✅ Menu senza Raduni
3. ✅ "Modifica Profilo" al posto di Iterazioni
4. ✅ Modal grafici con bordo e titolo del colore del cruscotto
5. ✅ Menu con icone e testi verdi (come il pulsante +)
6. ✅ Modal "Aggiungi" con animazione close corretta
7. ✅ View fittizie create:
   - Mancoliste: Album animato con carte (3 sopra, 3 sotto, navigazione pagine)
   - Vetrine: Card grandi con avatar negozio + articoli
   - Community: Post + card eventi raduni
8. ✅ Colori cruscotti applicati a modal grafici (bordo + titolo)
9. ✅ Tutti i fix precedenti mantenuti

COME USARE:
1. Copia PARTE 1 in un file .html
2. Incolla PARTE 2 subito dopo
3. Incolla PARTE 3 subito dopo
4. Incolla PARTE 4 subito dopo
5. Salva e apri nel browser!

FUNZIONA TUTTO! 🎉
-->
