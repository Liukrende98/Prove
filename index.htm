<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Articoli</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      margin: 16px 0;
    }

    /* TABS */
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      background: white;
      border: none;
      font-size: 16px;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.2s;
    }

    .tab.active {
      color: #2563eb;
      border-bottom: 3px solid #2563eb;
    }

    .tab-content {
      display: none;
      padding: 16px;
    }

    .tab-content.active {
      display: block;
    }

    .box {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* FILTRI */
    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
    }

    .filters input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .filters button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    /* FORM AGGIUNGI */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .btn-submit {
      width: 100%;
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: #10b981;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-submit:active {
      background: #059669;
    }

    /* DESKTOP TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #2563eb;
      color: white;
      padding: 10px;
      text-align: left;
      font-size: 14px;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      vertical-align: top;
    }

    tr:nth-child(even) {
      background: #f9fafb;
    }

    .desktop-table tbody tr {
      cursor: pointer;
    }

    .desktop-table tbody tr:hover {
      background: #e0f2fe !important;
    }

    /* MOBILE CARDS */
    .mobile-cards {
      display: none;
    }

    .card {
      background: white;
      margin-bottom: 14px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      overflow: hidden;
      cursor: pointer;
    }

    .card-header {
      padding: 14px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }

    .card-title {
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .card-body {
      padding: 14px;
      display: none;
    }

    .card.expanded .card-body {
      display: block;
    }

    .card-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .card-row:last-child {
      border-bottom: none;
    }

    .card-label {
      font-weight: 600;
      color: #374151;
    }

    .card-value {
      text-align: right;
      color: #1f2937;
    }

    .expand-icon {
      float: right;
      transition: transform 0.2s;
    }

    .card.expanded .expand-icon {
      transform: rotate(180deg);
    }

    .msg {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }

    .msg.success {
      background: #d1fae5;
      color: #065f46;
      display: block;
    }

    .msg.error {
      background: #fee2e2;
      color: #991b1b;
      display: block;
    }

    /* MOBILE (IPHONE) */
    @media (max-width: 768px) {
      .filters {
        grid-template-columns: 1fr;
      }

      .desktop-table {
        display: none;
      }

      .mobile-cards {
        display: block;
      }
    }
  </style>
</head>

<body>

  <h1>GESTIONE ARTICOLI</h1>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('archivio')">Archivio</button>
    <button class="tab" onclick="switchTab('aggiungi')">Aggiungi</button>
  </div>

  <!-- TAB ARCHIVIO -->
  <div id="tab-archivio" class="tab-content active">
    
    <!-- FILTRI -->
    <div class="box filters">
      <input id="fNome" placeholder="Nome articolo">
      <input id="fCategoria" placeholder="Categoria">
      <button onclick="carica()">Filtra</button>
    </div>

    <!-- TABELLA DESKTOP -->
    <div class="box desktop-table">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Descrizione</th>
            <th>Categoria</th>
            <th>Valore attuale</th>
            <th>Prezzo pagato</th>
          </tr>
        </thead>
        <tbody id="tableOut">
          <tr><td colspan="5">Caricamento…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- CARDS MOBILE -->
    <div id="cardsOut" class="mobile-cards">
      <div class="card">
        <div class="card-header">Caricamento…</div>
      </div>
    </div>

  </div>

  <!-- TAB AGGIUNGI -->
  <div id="tab-aggiungi" class="tab-content">
    
    <div class="box">
      <div id="formMsg" class="msg"></div>

      <form id="formAggiungi" onsubmit="aggiungi(event)">
        
        <div class="form-group">
          <label>Nome *</label>
          <input type="text" name="Nome" required>
        </div>

        <div class="form-group">
          <label>Descrizione</label>
          <textarea name="Descrizione"></textarea>
        </div>

        <div class="form-group">
          <label>Categoria</label>
          <input type="text" name="Categoria">
        </div>

        <div class="form-group">
          <label>Valore Attuale (€) *</label>
          <input type="number" step="0.01" name="ValoreAttuale" required>
        </div>

        <div class="form-group">
          <label>Prezzo Pagato (€) *</label>
          <input type="number" step="0.01" name="PrezzoPagato" required>
        </div>

        <button type="submit" class="btn-submit">Aggiungi Articolo</button>
      </form>
    </div>

  </div>

  <script>
    const SUPABASE_URL = "https://xoagoblnzvdqnktpfhlk.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Uf5-1uzQzL-OqI6dA-tl_g_RHpYxNds";

    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // SWITCH TAB
    function switchTab(tabName) {
      // Rimuovi active da tutti i tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      // Attiva il tab selezionato
      document.querySelector(`.tab:nth-child(${tabName === 'archivio' ? 1 : 2})`).classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Ricarica dati se torno su archivio
      if (tabName === 'archivio') {
        carica();
      }
    }

    // CARICA ARTICOLI
    async function carica() {
      const nome = document.getElementById("fNome").value;
      const categoria = document.getElementById("fCategoria").value;

      let query = client.from("Articoli").select("*");

      if (nome) query = query.ilike("Nome", `%${nome}%`);
      if (categoria) query = query.ilike("Categoria", `%${categoria}%`);

      const { data, error } = await query;

      const tableOut = document.getElementById("tableOut");
      const cardsOut = document.getElementById("cardsOut");

      if (error) {
        tableOut.innerHTML = `<tr><td colspan="5">${error.message}</td></tr>`;
        cardsOut.innerHTML = `<div class="card"><div class="card-header">${error.message}</div></div>`;
        return;
      }

      if (!data || data.length === 0) {
        tableOut.innerHTML = `<tr><td colspan="5">Nessun risultato</td></tr>`;
        cardsOut.innerHTML = `<div class="card"><div class="card-header">Nessun risultato</div></div>`;
        return;
      }

      // TABELLA DESKTOP
      tableOut.innerHTML = "";
      data.forEach(r => {
        tableOut.innerHTML += `
          <tr onclick="alert('${r.Nome}\\n\\n${r.Descrizione || 'Nessuna descrizione'}\\n\\nCategoria: ${r.Categoria || 'N/A'}\\nValore: ${Number(r.ValoreAttuale).toFixed(2)} €\\nPrezzo: ${Number(r.PrezzoPagato).toFixed(2)} €')">
            <td>${r.Nome ?? ""}</td>
            <td>${r.Descrizione ?? ""}</td>
            <td>${r.Categoria ?? ""}</td>
            <td>${Number(r.ValoreAttuale).toFixed(2)} €</td>
            <td>${Number(r.PrezzoPagato).toFixed(2)} €</td>
          </tr>`;
      });

      // CARDS MOBILE
      cardsOut.innerHTML = "";
      data.forEach(r => {
        cardsOut.innerHTML += `
          <div class="card" onclick="toggleCard(this)">
            <div class="card-header">
              <div class="card-title">${r.Nome ?? ""}
                <span class="expand-icon">▼</span>
              </div>
              <div class="card-subtitle">${r.Categoria ?? "Nessuna categoria"}</div>
            </div>
            <div class="card-body">
              <div class="card-row">
                <span class="card-label">Descrizione</span>
                <span class="card-value">${r.Descrizione || "—"}</span>
              </div>
              <div class="card-row">
                <span class="card-label">Valore Attuale</span>
                <span class="card-value">${Number(r.ValoreAttuale).toFixed(2)} €</span>
              </div>
              <div class="card-row">
                <span class="card-label">Prezzo Pagato</span>
                <span class="card-value">${Number(r.PrezzoPagato).toFixed(2)} €</span>
              </div>
            </div>
          </div>`;
      });
    }

    // TOGGLE CARD ESPANSIONE
    function toggleCard(card) {
      card.classList.toggle('expanded');
    }

    // AGGIUNGI ARTICOLO
    async function aggiungi(e) {
      e.preventDefault();
      
      const form = e.target;
      const formData = new FormData(form);
      
      const articolo = {
        Nome: formData.get('Nome'),
        Descrizione: formData.get('Descrizione'),
        Categoria: formData.get('Categoria'),
        ValoreAttuale: parseFloat(formData.get('ValoreAttuale')),
        PrezzoPagato: parseFloat(formData.get('PrezzoPagato'))
      };

      const { error } = await client.from('Articoli').insert([articolo]);

      const msg = document.getElementById('formMsg');

      if (error) {
        msg.className = 'msg error';
        msg.textContent = 'Errore: ' + error.message;
      } else {
        msg.className = 'msg success';
        msg.textContent = 'Articolo aggiunto con successo!';
        form.reset();
        
        setTimeout(() => {
          msg.className = 'msg';
        }, 3000);
      }
    }

    // CARICA AL LOAD
    carica();
  </script>

</body>
</html>
